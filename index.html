<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KARL Recovery Engine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.chatkit.openai.com/chatkit.js"></script>
  <script>
    window.chatkitConfig = {
      workflowId: "wf_68feb646168c8190acba7bc9e9c4923207722c157effc7f9",
      version: "1",
    };
  </script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #050712;
      --bg-elevated: #0f172a;
      --card: rgba(15, 23, 42, 0.8);
      --card-strong: rgba(26, 35, 58, 0.9);
      --text: #f8fafc;
      --text-muted: #cbd5f5;
      --neon-blue: #38bdf8;
      --mint: #4ade80;
      --coral: #fb7185;
      --gold: #facc15;
      --shadow: 0 18px 34px rgba(2, 6, 23, 0.55);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Manrope", system-ui, sans-serif;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(74, 222, 128, 0.12), transparent 50%),
        linear-gradient(160deg, #020617, #0b1120 55%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
    }

    body.low-energy {
      --card: rgba(10, 15, 30, 0.94);
      --shadow: none;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: clamp(1rem, 2vw, 2rem);
    }

    .command-strip {
      position: sticky;
      top: 0;
      z-index: 50;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: center;
      padding: 0.75rem 0;
      background: rgba(5, 7, 18, 0.86);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      font-weight: 700;
      font-size: clamp(1rem, 2vw, 1.35rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.92), rgba(250, 204, 21, 0.8));
      color: #020617;
      font-size: 0.85rem;
      font-weight: 800;
    }

    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-tabs button {
      position: relative;
      background: rgba(30, 41, 89, 0.55);
      border: 1px solid transparent;
      color: var(--text);
      padding: 0.55rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .nav-tabs button.active {
      border-color: rgba(56, 189, 248, 0.9);
      background: rgba(56, 189, 248, 0.18);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.22);
    }

    .nav-tabs button:focus-visible {
      outline: 2px solid var(--neon-blue);
      outline-offset: 2px;
    }

    .streak-panel {
      justify-self: end;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .streak-count {
      display: grid;
      gap: 0.1rem;
      text-align: right;
    }

    .streak-count strong {
      font-size: 1.1rem;
      letter-spacing: 0.06em;
    }

    .streak-count span {
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .reset-btn {
      background: rgba(248, 113, 113, 0.18);
      border: 1px solid rgba(248, 113, 113, 0.45);
      color: var(--text);
      padding: 0.45rem 0.85rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .reset-btn:hover {
      transform: translateY(-1px);
      background: rgba(248, 113, 113, 0.28);
    }

    main {
      display: grid;
      gap: clamp(1.5rem, 3vw, 2.5rem);
      margin-top: 1.25rem;
    }

    .page {
      display: none;
      animation: fadeIn 0.35s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.2rem;
    }

    .section-title h2 {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2.2rem);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .section-title span {
      font-size: 0.9rem;
      color: var(--text-muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .task-stack {
      display: grid;
      gap: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: clamp(1rem, 2vw, 1.5rem);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow);
      display: grid;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      opacity: 0;
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.28), transparent 60%);
      transition: opacity 0.3s ease;
    }

    .card.complete::after {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.15rem;
    }

    .task-status {
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .task-sub {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .primary-btn,
    .ghost-btn {
      border: none;
      border-radius: 999px;
      padding: 0.65rem 1.25rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .primary-btn {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.9), rgba(250, 204, 21, 0.7));
      color: #020617;
      box-shadow: 0 12px 24px rgba(56, 189, 248, 0.2);
    }

    .ghost-btn {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text);
    }

    .primary-btn:active,
    .ghost-btn:active {
      transform: scale(0.97);
    }

    .timer-display {
      font-size: 2.4rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-align: center;
    }

    .progress-track {
      height: 8px;
      width: 100%;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--mint), var(--neon-blue));
      transition: width 0.2s linear;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip {
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(148, 163, 184, 0.08);
      cursor: pointer;
      transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease;
    }

    .chip.active {
      border-color: var(--mint);
      background: rgba(74, 222, 128, 0.15);
      color: var(--mint);
    }

    .toggle {
      position: relative;
      width: 58px;
      height: 30px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.3);
      transition: background 0.2s ease;
      cursor: pointer;
    }

    .toggle::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .toggle.active {
      background: rgba(74, 222, 128, 0.45);
    }

    .toggle.active::after {
      transform: translateX(26px);
      background: var(--mint);
    }

    .celebration {
      display: none;
      background: var(--card-strong);
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(250, 204, 21, 0.45);
      box-shadow: 0 22px 40px rgba(250, 204, 21, 0.25);
    }

    .celebration.active {
      display: grid;
      gap: 0.75rem;
      animation: pop 0.5s ease;
    }

    .celebration img {
      width: min(280px, 70%);
      margin: 0 auto;
      border-radius: 12px;
    }

    @keyframes pop {
      0% {
        transform: scale(0.9);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Streak Engine */
    .streak-grid {
      overflow-x: auto;
      background: var(--card);
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow);
    }

    .streak-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 520px;
    }

    .streak-table th,
    .streak-table td {
      text-align: center;
      padding: 0.65rem;
      border: 1px solid rgba(148, 163, 184, 0.12);
      font-size: 0.85rem;
    }

    .streak-table thead th {
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .streak-table .day-achieved {
      background: rgba(74, 222, 128, 0.18);
      color: var(--mint);
    }

    .streak-checkbox {
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(148, 163, 184, 0.1);
      position: relative;
      cursor: pointer;
      transition: transform 0.15s ease, background 0.2s ease;
    }

    .streak-checkbox:checked {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.9), rgba(56, 189, 248, 0.8));
      border-color: transparent;
    }

    .streak-checkbox:checked::after {
      content: "‚úî";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #020617;
      font-weight: 800;
    }

    .streak-heat {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
    }

    .heat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.14);
      display: grid;
      gap: 0.5rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .badge {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: rgba(250, 204, 21, 0.18);
      color: var(--gold);
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      text-transform: uppercase;
      box-shadow: 0 12px 20px rgba(250, 204, 21, 0.2);
    }

    .badge.locked {
      background: rgba(148, 163, 184, 0.15);
      color: rgba(148, 163, 184, 0.8);
      box-shadow: none;
    }

    /* Micro Rituals */
    .ritual-grid {
      display: grid;
      gap: 1rem;
    }

    .ritual-set {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: 1.2rem;
      display: grid;
      gap: 0.75rem;
      box-shadow: var(--shadow);
    }

    .ritual-set header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .ritual-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .ritual-item {
      background: rgba(56, 189, 248, 0.1);
      border-radius: 14px;
      padding: 0.55rem 0.85rem;
      border: 1px solid rgba(56, 189, 248, 0.3);
      font-size: 0.9rem;
      cursor: text;
      min-width: 120px;
    }

    .ritual-item[contenteditable="true"] {
      background: rgba(251, 113, 133, 0.16);
      border-color: rgba(251, 113, 133, 0.5);
    }

    .spin-panel {
      display: grid;
      gap: 0.75rem;
      justify-items: start;
    }

    .spin-output {
      background: rgba(74, 222, 128, 0.12);
      border-left: 4px solid rgba(74, 222, 128, 0.65);
      padding: 0.85rem 1rem;
      border-radius: 14px;
      font-weight: 600;
    }

    /* Quick Win Log */
    .win-form {
      display: grid;
      gap: 0.6rem;
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow);
    }

    .win-input {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(148, 163, 184, 0.1);
      padding: 0.65rem 0.85rem;
      color: var(--text);
      font-size: 1rem;
      width: 100%;
    }

    .win-input::placeholder {
      color: rgba(203, 213, 225, 0.6);
    }

    .wins-list {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .win-card {
      background: rgba(30, 41, 89, 0.55);
      border-radius: 14px;
      padding: 0.75rem 1rem;
      display: grid;
      gap: 0.35rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .win-card time {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .voice-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    audio {
      width: 100%;
    }

    /* Settings */
    .settings-grid {
      display: grid;
      gap: 1rem;
    }

    .settings-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow);
      display: grid;
      gap: 0.8rem;
    }

    /* Chatbot container */
    #chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      z-index: 999;
    }

    #chat-window {
      height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #chat-input {
      width: 70%;
    }

    #send-button {
      width: 25%;
    }

    label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    input[type="time"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
    }

    @media (max-width: 900px) {
      .command-strip {
        grid-template-columns: 1fr;
        justify-items: center;
        text-align: center;
      }

      .streak-panel {
        justify-self: center;
      }

      .section-title {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 640px) {
      .timer-display {
        font-size: 2rem;
      }

      .nav-tabs {
        justify-content: center;
      }

      .nav-tabs button {
        flex: 1 1 45%;
      }

      .brand {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <chatkit-widget></chatkit-widget>
  <div class="app">
    <header class="command-strip" role="banner">
      <div class="brand">
        <span>KR</span>
        KARL Recovery Engine
      </div>
      <nav class="nav-tabs" role="tablist" aria-label="ARCC navigation">
        <button data-target="home" role="tab">üè† Home</button>
        <button class="active" data-target="today" role="tab" aria-selected="true">üìÖ Today</button>
        <button data-target="streaks" role="tab">üî• Streaks</button>
        <button data-target="wins" role="tab">üèÜ Wins</button>
        <button data-target="settings" role="tab">‚öôÔ∏è Settings</button>
      </nav>
      <div class="streak-panel">
        <div class="streak-count">
          <span>Current streak</span>
          <strong id="streakCount">0 days</strong>
        </div>
        <button class="reset-btn" id="resetDay">Quick Reset</button>
      </div>
    </header>
    <main>
      <section id="today" class="page active" role="tabpanel">
        <div class="section-title">
          <h2>Today&rsquo;s 5-Move Stack</h2>
          <span>Tap once ¬∑ Momentum on</span>
        </div>
        <div class="task-stack">
          <article class="card" data-task="chartSprint">
            <div class="card-header">
              <h3>Chart Sprint</h3>
              <div class="task-status" data-status="chartSprint">Ready</div>
            </div>
            <div class="timer-display" id="chartTimer">05:00</div>
            <div class="progress-track"><div class="progress-bar" id="chartProgress"></div></div>
            <div class="chip-row">
              <button class="primary-btn" id="startChart">‚ñ∂ Start 5-minute push</button>
              <button class="ghost-btn" id="chartComplete">Mark complete</button>
            </div>
          </article>
          <article class="card" data-task="sleepProtocol">
            <div class="card-header">
              <h3>Sleep Protocol</h3>
              <div class="task-status" data-status="sleepProtocol">Unlogged</div>
            </div>
            <div class="chip-row">
              <button class="ghost-btn" id="logWake">Log wake now</button>
              <div class="chip" id="wakeDisplay">No wake time logged</div>
            </div>
            <div class="chip-row">
              <span>Sunlight exposure</span>
              <div class="toggle" id="sunToggle" role="switch" aria-checked="false"></div>
            </div>
          </article>
          <article class="card" data-task="movement">
            <div class="card-header">
              <h3>Movement</h3>
              <div class="task-status" data-status="movement">Choose mode</div>
            </div>
            <p class="task-sub">Select what feels doable.</p>
            <div class="chip-row" id="movementChips">
              <div class="chip" data-move="walk">Walk</div>
              <div class="chip" data-move="core">Core</div>
              <div class="chip" data-move="stretch">Stretch</div>
              <div class="chip" data-move="skip">Skip (reset)</div>
            </div>
          </article>
          <article class="card" data-task="boundaries">
            <div class="card-header">
              <h3>Boundaries</h3>
              <div class="task-status" data-status="boundaries">Pending</div>
            </div>
            <div class="chip-row" style="justify-content: space-between; align-items: center;">
              <span>Court app muted?</span>
              <div class="toggle" id="boundaryToggle" role="switch" aria-checked="false"></div>
            </div>
          </article>
          <article class="card" data-task="connection">
            <div class="card-header">
              <h3>Connection</h3>
              <div class="task-status" data-status="connection">Reach out</div>
            </div>
            <p>Tap below and send any message. Momentum beats perfect words.</p>
            <button class="primary-btn" id="connectionBtn">Text someone now</button>
          </article>
        </div>
        <div class="celebration" id="celebration">
          <h3>Streak Unlocked!</h3>
          <p>You just stacked all five moves. Bask in that gold glow. üîÜ</p>
          <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYjc5cGkxdzBodmo0Nm50dmI1OTZ4dWN0YXNycHhmaG5hZGVmMWRldiZlcD12MV9pbnRlcm5hbF9naWZzLmZpc2h8ZDJmMDFqYzh5cXpxaGZ3dHVnMTJwcnE2aSZjdD1n/26ufdipQqU2lhNA4g/giphy.gif" alt="Celebration" />
          <div class="badge">Momentum x1</div>
        </div>
      </section>
      <section id="streaks" class="page" role="tabpanel" aria-hidden="true">
        <div class="section-title">
          <h2>Streak Engine</h2>
          <span>See the heat. Keep the flame.</span>
        </div>
        <div class="streak-grid">
          <table class="streak-table" aria-label="Daily streak grid">
            <thead>
              <tr id="streakHeadRow"></tr>
            </thead>
            <tbody id="streakBody"></tbody>
          </table>
        </div>
        <div class="streak-heat">
          <div class="heat-card">
            <strong>Daily target</strong>
            <p id="dailyTargetText">Hit 3 of 5 moves to keep the streak.</p>
          </div>
          <div class="heat-card">
            <strong>Badges</strong>
            <div class="badge-row" id="badgeRow"></div>
          </div>
          <div class="heat-card">
            <strong>Energy meter</strong>
            <p id="energyNote">Low energy mode off. Full color, full dopamine.</p>
          </div>
        </div>
      </section>
      <section id="wins" class="page" role="tabpanel" aria-hidden="true">
        <div class="section-title">
          <h2>Quick Wins Log</h2>
          <span>Capture the sparks</span>
        </div>
        <div class="win-form">
          <input class="win-input" id="winInput" type="text" maxlength="120" placeholder="Type one line about the win..." />
          <div class="voice-controls">
            <button class="ghost-btn" id="voiceToggle">üéôÔ∏è Hold to record</button>
            <span id="voiceStatus">Voice memos ready</span>
          </div>
          <button class="primary-btn" id="addWin">Add win</button>
        </div>
        <div class="wins-list" id="winsList" aria-live="polite"></div>
      </section>
      <section id="home" class="page" role="tabpanel" aria-hidden="true">
        <div class="section-title">
          <h2>Micro-Rituals</h2>
          <span>Refresh your stack</span>
        </div>
        <div class="ritual-grid">
          <div class="ritual-set" data-ritual="morning">
            <header>
              <h3>Morning ignition</h3>
              <button class="ghost-btn" data-edit="morning">Edit</button>
            </header>
            <div class="ritual-items" id="morningRituals"></div>
          </div>
          <div class="ritual-set" data-ritual="evening">
            <header>
              <h3>Evening wind-down</h3>
              <button class="ghost-btn" data-edit="evening">Edit</button>
            </header>
            <div class="ritual-items" id="eveningRituals"></div>
          </div>
          <div class="ritual-set" data-ritual="dopamine">
            <header>
              <h3>Dopamine reset tools</h3>
              <button class="ghost-btn" data-edit="dopamine">Edit</button>
            </header>
            <div class="ritual-items" id="dopamineRituals"></div>
          </div>
          <div class="ritual-set spin-panel">
            <strong>Need novelty?</strong>
            <button class="primary-btn" id="spinNovelty">Spin for novelty</button>
            <div class="spin-output" id="noveltyOutput">Let&rsquo;s remix your next move.</div>
          </div>
        </div>
      </section>
      <section id="settings" class="page" role="tabpanel" aria-hidden="true">
        <div class="section-title">
          <h2>Settings</h2>
          <span>Fine-tune the engine</span>
        </div>
      <div class="settings-grid">
        <div class="settings-card">
          <label for="wakeTimeSetting">Preferred wake time</label>
          <input type="time" id="wakeTimeSetting" />
          <button class="ghost-btn" id="saveWake">Save wake time</button>
        </div>
        <div class="settings-card">
          <label for="streakGoal">Daily streak goal</label>
          <input type="number" id="streakGoal" min="1" max="5" />
          <button class="ghost-btn" id="saveGoal">Set goal</button>
        </div>
        <div class="settings-card">
          <label for="lowEnergyToggle">Low energy mode</label>
          <div class="toggle" id="lowEnergyToggle" role="switch" aria-checked="false"></div>
          <small>Swap to simplified visuals when you need the lowest lift.</small>
        </div>
        <div class="settings-card">
          <label for="soundToggle">Sound reinforcement</label>
          <div class="toggle" id="soundToggle" role="switch" aria-checked="true"></div>
          <small>Turn dopamine hits on or off.</small>
        </div>
        <div class="settings-card">
          <button class="ghost-btn" id="clearData">Clear all local data</button>
          <small>This keeps everything client-side. Clearing wipes streaks and wins.</small>
        </div>
      </div>
      </section>
    </main>
  </div>
  <audio id="rewardSound" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAACcQCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=" type="audio/mp3" />
  </audio>
  <canvas id="confettiCanvas" style="position:fixed; inset:0; pointer-events:none; width:100vw; height:100vh; display:none;"></canvas>
  <div id="chatbot-container">
    <div id="chat-window"></div>
    <input type="text" id="chat-input" placeholder="Talk to Karl..." />
    <button id="send-button">Send</button>
  </div>

  <script>
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => Array.from(document.querySelectorAll(selector));

    const clone = (value) => (typeof structuredClone === 'function' ? structuredClone(value) : JSON.parse(JSON.stringify(value)));

    const defaultState = {
      currentTab: 'today',
      streakGoal: 3,
      lowEnergy: false,
      soundOn: true,
      wakeTime: '',
      tasks: {
        chartSprint: { done: false, timer: 300, running: false },
        sleepProtocol: { done: false, wakeTime: null, sunlight: false },
        movement: { done: false, choice: null },
        boundaries: { done: false, muted: false },
        connection: { done: false }
      },
      streakHistory: {},
      wins: [],
      rituals: {
        morning: ['Sunlight on skin', 'Music with tempo', 'One glass of water'],
        evening: ['Screens dimmed 30 min', 'Stretch + breathe', 'Gratitude sentence'],
        dopamine: ['Random meme break', '5-min pump track', 'Ice cube reset']
      }
    };

    const NOVELTY_PROMPTS = [
      'Do your next task standing.',
      'Narrate your move like a dramatic villain.',
      'Set a 90-second timer and go full speed.',
      'Put on the most ridiculous soundtrack you can find.',
      'Send a ‚Äúthinking of you‚Äù meme before the task.',
      'Change locations ‚Äì even if it‚Äôs just another chair.',
      'Pretend you are being filmed for your highlight reel.',
      'Write the next step on a sticky note and stick it on your shirt.',
      'Whisper the task to yourself before you start.',
      'Use your non-dominant hand for the first minute.'
    ];

    const STORAGE_KEY = 'arcc_state_v2';
    let state = loadState();
    let chartInterval;
    let recording = false;
    let mediaRecorder;
    let recordedChunks = [];

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return clone(defaultState);
        const parsed = JSON.parse(saved);
        return mergeState(parsed, defaultState);
      } catch (err) {
        console.error(err);
        return clone(defaultState);
      }
    }

    function mergeState(saved, defaults) {
      const merged = clone(defaults);
      function deepMerge(target, source) {
        for (const key of Object.keys(source)) {
          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            target[key] = target[key] || {};
            deepMerge(target[key], source[key]);
          } else {
            target[key] = source[key];
          }
        }
        return target;
      }
      deepMerge(merged, saved);
      return merged;
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function formatTime(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function updateTaskStatus(taskKey, text) {
      const el = document.querySelector(`[data-status="${taskKey}"]`);
      if (el) el.textContent = text;
      const card = document.querySelector(`[data-task="${taskKey}"]`);
      if (card) {
        card.classList.toggle('complete', !!state.tasks[taskKey].done);
      }
    }

    function updateChartTimer() {
      $('#chartTimer').textContent = formatTime(state.tasks.chartSprint.timer);
      $('#chartProgress').style.width = `${((300 - state.tasks.chartSprint.timer) / 300) * 100}%`;
    }

    function runChartTimer() {
      if (chartInterval) clearInterval(chartInterval);
      chartInterval = setInterval(() => {
        if (state.tasks.chartSprint.timer <= 0) {
          clearInterval(chartInterval);
          chartInterval = null;
          state.tasks.chartSprint.running = false;
          state.tasks.chartSprint.done = true;
          updateTodayUI();
          saveState();
          return;
        }
        state.tasks.chartSprint.timer -= 1;
        if (state.tasks.chartSprint.timer % 5 === 0) saveState();
        updateChartTimer();
      }, 1000);
    }

    function updateTodayUI() {
      updateChartTimer();
      updateTaskStatus('chartSprint', state.tasks.chartSprint.done ? 'Complete' : state.tasks.chartSprint.running ? 'Running' : 'Ready');

      const wakeDisplay = state.tasks.sleepProtocol.wakeTime
        ? `Woke at ${state.tasks.sleepProtocol.wakeTime}`
        : 'No wake time logged';
      $('#wakeDisplay').textContent = wakeDisplay;
      $('#sunToggle').classList.toggle('active', state.tasks.sleepProtocol.sunlight);
      $('#sunToggle').setAttribute('aria-checked', state.tasks.sleepProtocol.sunlight);
      updateTaskStatus('sleepProtocol', state.tasks.sleepProtocol.done ? 'Logged' : 'Unlogged');

      $$('#movementChips .chip').forEach((chip) => {
        chip.classList.toggle('active', state.tasks.movement.choice === chip.dataset.move);
      });
      updateTaskStatus('movement', state.tasks.movement.done ? `Go-to: ${state.tasks.movement.choice}` : 'Choose mode');

      $('#boundaryToggle').classList.toggle('active', state.tasks.boundaries.muted);
      $('#boundaryToggle').setAttribute('aria-checked', state.tasks.boundaries.muted);
      updateTaskStatus('boundaries', state.tasks.boundaries.done ? 'Protected' : 'Pending');

      updateTaskStatus('connection', state.tasks.connection.done ? 'Reached out' : 'Reach out');

      const allDone = Object.values(state.tasks).every((task) => task.done);
      const celebration = $('#celebration');
      const wasActive = celebration.classList.contains('active');
      celebration.classList.toggle('active', allDone);
      if (allDone && !wasActive) {
        celebration.scrollIntoView({ behavior: 'smooth', block: 'center' });
        fireConfetti();
        playReward();
        updateStreakHistory(true);
      } else if (!allDone) {
        updateStreakHistory();
      }
    }

    function updateStreakHistory(force = false) {
      const todayKey = new Date().toISOString().slice(0, 10);
      const current = state.streakHistory[todayKey] || { tasks: {}, achieved: false };
      current.tasks = {
        chartSprint: state.tasks.chartSprint.done,
        sleepProtocol: state.tasks.sleepProtocol.done,
        movement: state.tasks.movement.done,
        boundaries: state.tasks.boundaries.done,
        connection: state.tasks.connection.done
      };
      const completedCount = Object.values(current.tasks).filter(Boolean).length;
      const achieved = completedCount >= state.streakGoal;
      if (achieved && (!current.achieved || force)) {
        current.achieved = true;
      } else if (!achieved) {
        current.achieved = false;
      }
      state.streakHistory[todayKey] = current;
      saveState();
      updateStreakUI();
    }

    function updateStreakUI() {
      const headRow = $('#streakHeadRow');
      const body = $('#streakBody');
      headRow.innerHTML = '';
      body.innerHTML = '';
      const leadingHead = document.createElement('th');
      leadingHead.textContent = 'Move';
      headRow.appendChild(leadingHead);
      const tasks = ['chartSprint', 'sleepProtocol', 'movement', 'boundaries', 'connection'];
      const labels = {
        chartSprint: 'Chart',
        sleepProtocol: 'Sleep',
        movement: 'Move',
        boundaries: 'Bound',
        connection: 'Connect'
      };
      const days = [...Array(7)].map((_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        return date;
      });
      days.forEach((date) => {
        const key = date.toISOString().slice(0, 10);
        const display = date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
        const th = document.createElement('th');
        th.textContent = display;
        if (state.streakHistory[key]?.achieved) th.classList.add('day-achieved');
        headRow.appendChild(th);
      });
      tasks.forEach((task) => {
        const row = document.createElement('tr');
        row.innerHTML = `<th scope="row">${labels[task]}</th>`;
        days.forEach((date) => {
          const key = date.toISOString().slice(0, 10);
          const history = state.streakHistory[key] || { tasks: {} };
          const achievedDay = !!(state.streakHistory[key] && state.streakHistory[key].achieved);
          const cell = document.createElement('td');
          if (achievedDay) cell.classList.add('day-achieved');
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'streak-checkbox';
          input.checked = !!history.tasks[task];
          input.dataset.day = key;
          input.dataset.task = task;
          cell.appendChild(input);
          row.appendChild(cell);
        });
        body.appendChild(row);
      });
      const consecutive = calculateStreak();
      $('#streakCount').textContent = `${consecutive} day${consecutive === 1 ? '' : 's'}`;
      updateBadges(consecutive);
      $('#dailyTargetText').textContent = `Hit ${state.streakGoal} of 5 moves to keep the streak.`;
    }

    function calculateStreak() {
      let count = 0;
      const todayKey = new Date().toISOString().slice(0, 10);
      let pointer = new Date(todayKey);
      for (;;) {
        const key = pointer.toISOString().slice(0, 10);
        const entry = state.streakHistory[key];
        if (entry && entry.achieved) {
          count += 1;
          pointer.setDate(pointer.getDate() - 1);
        } else {
          break;
        }
      }
      return count;
    }

    function updateBadges(streak) {
      const badgeRow = $('#badgeRow');
      badgeRow.innerHTML = '';
      const milestones = [3, 7, 14];
      milestones.forEach((day) => {
        const badge = document.createElement('div');
        badge.className = 'badge' + (streak >= day ? '' : ' locked');
        badge.textContent = streak >= day ? `${day}-day badge unlocked` : `${day}-day badge`; 
        badgeRow.appendChild(badge);
      });
    }

    function initNav() {
      $$('.nav-tabs button').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.target;
          showPage(target);
        });
      });
    }

    function showPage(id) {
      const pageId = id === 'micro' ? 'home' : id;
      $$('.nav-tabs button').forEach((btn) => {
        const match = btn.dataset.target === pageId;
        btn.classList.toggle('active', match);
        btn.setAttribute('aria-selected', match);
      });
      $$('.page').forEach((page) => {
        const active = page.id === pageId;
        page.classList.toggle('active', active);
        page.setAttribute('aria-hidden', !active);
      });
      state.currentTab = pageId;
      saveState();
    }

    function bindTodayActions() {
      $('#startChart').addEventListener('click', () => {
        if (state.tasks.chartSprint.running) return;
        state.tasks.chartSprint.running = true;
        state.tasks.chartSprint.timer = 300;
        updateTodayUI();
        saveState();
        runChartTimer();
      });

      $('#chartComplete').addEventListener('click', () => {
        if (chartInterval) clearInterval(chartInterval);
        chartInterval = null;
        state.tasks.chartSprint.running = false;
        state.tasks.chartSprint.done = true;
        state.tasks.chartSprint.timer = 0;
        updateTodayUI();
        saveState();
      });

      $('#logWake').addEventListener('click', () => {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        state.tasks.sleepProtocol.wakeTime = timeString;
        state.tasks.sleepProtocol.done = !!(state.tasks.sleepProtocol.wakeTime && state.tasks.sleepProtocol.sunlight);
        saveState();
        updateTodayUI();
      });

      $('#sunToggle').addEventListener('click', () => {
        state.tasks.sleepProtocol.sunlight = !state.tasks.sleepProtocol.sunlight;
        state.tasks.sleepProtocol.done = !!(state.tasks.sleepProtocol.wakeTime && state.tasks.sleepProtocol.sunlight);
        saveState();
        updateTodayUI();
      });

      $('#boundaryToggle').addEventListener('click', () => {
        state.tasks.boundaries.muted = !state.tasks.boundaries.muted;
        state.tasks.boundaries.done = state.tasks.boundaries.muted;
        saveState();
        updateTodayUI();
      });

      $('#connectionBtn').addEventListener('click', () => {
        state.tasks.connection.done = true;
        playReward();
        fireConfetti(300);
        saveState();
        updateTodayUI();
        if (navigator.share) {
          navigator.share({
            text: 'Thinking of you. Sending some love from the KARL Recovery Engine.'
          }).catch(() => {});
        }
      });

      $('#resetDay').addEventListener('click', resetToday);

      $('#movementChips').addEventListener('click', (event) => {
        const chip = event.target.closest('.chip');
        if (!chip) return;
        const move = chip.dataset.move;
        if (move === 'skip') {
          state.tasks.movement.done = false;
          state.tasks.movement.choice = null;
        } else {
          state.tasks.movement.choice = move;
          state.tasks.movement.done = true;
        }
        saveState();
        updateTodayUI();
      });
    }

    function resetToday() {
      if (chartInterval) clearInterval(chartInterval);
      chartInterval = null;
      state.tasks.chartSprint = { done: false, timer: 300, running: false };
      state.tasks.sleepProtocol = { done: false, wakeTime: null, sunlight: false };
      state.tasks.movement = { done: false, choice: null };
      state.tasks.boundaries = { done: false, muted: false };
      state.tasks.connection = { done: false };
      saveState();
      updateTodayUI();
    }

    function bindStreakGrid() {
      $('#streakBody').addEventListener('change', (event) => {
        if (!event.target.matches('.streak-checkbox')) return;
        const { day, task } = event.target.dataset;
        state.streakHistory[day] = state.streakHistory[day] || { tasks: {}, achieved: false };
        state.streakHistory[day].tasks[task] = event.target.checked;
        const completed = Object.values(state.streakHistory[day].tasks).filter(Boolean).length;
        state.streakHistory[day].achieved = completed >= state.streakGoal;
        saveState();
        updateStreakUI();
      });
    }

    function initRituals() {
      ['morning', 'evening', 'dopamine'].forEach((type) => {
        const container = document.getElementById(`${type}Rituals`);
        container.innerHTML = '';
        state.rituals[type].forEach((item, index) => {
          const chip = document.createElement('div');
          chip.className = 'ritual-item';
          chip.textContent = item;
          chip.dataset.index = index;
          chip.dataset.type = type;
          container.appendChild(chip);
        });
      });
      $$('.ritual-set button[data-edit]').forEach((btn) => {
        btn.addEventListener('click', () => toggleRitualEdit(btn.dataset.edit));
      });
    }

    function toggleRitualEdit(type) {
      const container = document.getElementById(`${type}Rituals`);
      const editable = container.dataset.editing === 'true';
      container.dataset.editing = (!editable).toString();
      container.querySelectorAll('.ritual-item').forEach((item) => {
        item.contentEditable = !editable;
        if (!editable) {
          item.focus();
        } else {
          const index = Number(item.dataset.index);
          state.rituals[type][index] = item.textContent.trim();
        }
      });
      if (editable) saveState();
      const button = document.querySelector(`.ritual-set[data-ritual="${type}"] button[data-edit]`);
      if (button) button.textContent = editable ? 'Edit' : 'Save';
    }

    function bindNovelty() {
      $('#spinNovelty').addEventListener('click', () => {
        const prompt = NOVELTY_PROMPTS[Math.floor(Math.random() * NOVELTY_PROMPTS.length)];
        $('#noveltyOutput').textContent = prompt;
        playReward();
      });
    }

    function bindWins() {
      $('#addWin').addEventListener('click', () => {
        const value = $('#winInput').value.trim();
        if (!value && !recordedChunks.length) return;
        const entry = {
          id: crypto.randomUUID(),
          text: value,
          createdAt: new Date().toISOString(),
          audio: null
        };
        if (recordedChunks.length) {
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onloadend = () => {
            entry.audio = reader.result;
            pushWin(entry);
            recordedChunks = [];
          };
          reader.readAsDataURL(blob);
        } else {
          pushWin(entry);
        }
        $('#winInput').value = '';
      });

      $('#voiceToggle').addEventListener('mousedown', startRecording);
      $('#voiceToggle').addEventListener('touchstart', startRecording);
      window.addEventListener('mouseup', stopRecording);
      window.addEventListener('touchend', stopRecording);
    }

    function pushWin(entry) {
      state.wins.unshift(entry);
      playReward();
      fireConfetti(300);
      saveState();
      renderWins();
    }

    function renderWins() {
      const list = $('#winsList');
      list.innerHTML = '';
      if (!state.wins.length) {
        const empty = document.createElement('p');
        empty.textContent = 'No wins logged yet. Your next tiny victory goes here.';
        list.appendChild(empty);
        return;
      }
      state.wins.forEach((win) => {
        const card = document.createElement('div');
        card.className = 'win-card';
        const time = document.createElement('time');
        const date = new Date(win.createdAt);
        time.textContent = date.toLocaleString();
        card.appendChild(time);
        if (win.text) {
          const text = document.createElement('div');
          text.textContent = win.text;
          card.appendChild(text);
        }
        if (win.audio) {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = win.audio;
          card.appendChild(audio);
        }
        list.appendChild(card);
      });
    }

    async function startRecording(event) {
      event.preventDefault();
      if (recording) return;
      try {
        if (!mediaRecorder) {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
          };
          mediaRecorder.onstop = () => {
            $('#voiceStatus').textContent = recordedChunks.length ? 'Audio captured' : 'Voice memos ready';
          };
        }
        recordedChunks = [];
        mediaRecorder.start();
        recording = true;
        $('#voiceStatus').textContent = 'Recording... release to save';
      } catch (err) {
        $('#voiceStatus').textContent = 'Mic not available';
      }
    }

    function stopRecording() {
      if (!recording || !mediaRecorder) return;
      recording = false;
      mediaRecorder.stop();
      $('#voiceStatus').textContent = 'Processing audio...';
    }

    function bindSettings() {
      $('#saveWake').addEventListener('click', () => {
        state.wakeTime = $('#wakeTimeSetting').value;
        saveState();
        updateTodayUI();
      });
      $('#saveGoal').addEventListener('click', () => {
        const value = Number($('#streakGoal').value) || 3;
        state.streakGoal = Math.min(5, Math.max(1, value));
        saveState();
        updateStreakHistory();
      });
      $('#lowEnergyToggle').addEventListener('click', () => {
        state.lowEnergy = !state.lowEnergy;
        document.body.classList.toggle('low-energy', state.lowEnergy);
        $('#lowEnergyToggle').classList.toggle('active', state.lowEnergy);
        $('#lowEnergyToggle').setAttribute('aria-checked', state.lowEnergy);
        $('#energyNote').textContent = state.lowEnergy ? 'Low energy mode on. Buttons stay big, visuals calm.' : 'Low energy mode off. Full color, full dopamine.';
        saveState();
      });
      $('#soundToggle').addEventListener('click', () => {
        state.soundOn = !state.soundOn;
        $('#soundToggle').classList.toggle('active', state.soundOn);
        $('#soundToggle').setAttribute('aria-checked', state.soundOn);
        saveState();
      });
      $('#clearData').addEventListener('click', () => {
        if (!confirm('Clear all ARCC data?')) return;
        state = clone(defaultState);
        saveState();
        hydrate();
      });
    }

    function playReward() {
      if (!state.soundOn) return;
      const audio = $('#rewardSound');
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }

    function fireConfetti(duration = 600) {
      const canvas = $('#confettiCanvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      resizeCanvas();
      const palette = getPalette();
      const particles = Array.from({ length: 80 }, () => ({
        x: Math.random() * canvas.width,
        y: -10,
        size: Math.random() * 6 + 4,
        speed: Math.random() * 3 + 2,
        color: palette[Math.floor(Math.random() * palette.length)],
        tilt: Math.random() * 0.8 - 0.4
      }));

      let start;
      canvas.style.display = 'block';

      function draw(timestamp) {
        if (!start) start = timestamp;
        const progress = timestamp - start;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p) => {
          p.y += p.speed;
          p.x += p.tilt;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.size, p.size);
        });
        if (progress < duration) {
          requestAnimationFrame(draw);
        } else {
          canvas.style.display = 'none';
        }
      }
      requestAnimationFrame(draw);
    }

    function getPalette() {
      const styles = getComputedStyle(document.documentElement);
      return ['--neon-blue', '--mint', '--coral', '--gold'].map((token) => {
        const value = styles.getPropertyValue(token).trim();
        return value || '#38bdf8';
      });
    }

    function resizeCanvas() {
      const canvas = $('#confettiCanvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function hydrate() {
      document.body.classList.toggle('low-energy', state.lowEnergy);
      $('#lowEnergyToggle').classList.toggle('active', state.lowEnergy);
      $('#lowEnergyToggle').setAttribute('aria-checked', state.lowEnergy);
      $('#soundToggle').classList.toggle('active', state.soundOn);
      $('#soundToggle').setAttribute('aria-checked', state.soundOn);
      $('#wakeTimeSetting').value = state.wakeTime;
      $('#streakGoal').value = state.streakGoal;
      const initialTab = state.currentTab === 'micro' ? 'home' : state.currentTab || 'today';
      showPage(initialTab);
      initRituals();
      renderWins();
      updateTodayUI();
      if (state.tasks.chartSprint.running && state.tasks.chartSprint.timer > 0) {
        runChartTimer();
      }
    }

    function init() {
      initNav();
      bindTodayActions();
      bindStreakGrid();
      bindNovelty();
      bindWins();
      bindSettings();
      window.addEventListener('resize', resizeCanvas);
      hydrate();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>

  <script>
    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    function appendMessage(sender, message) {
      const msg = document.createElement('div');
      msg.innerHTML = `<strong>${sender}:</strong> ${message}`;
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    sendButton.addEventListener('click', async () => {
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      appendMessage('You', userMessage);
      chatInput.value = '';

      appendMessage('Karl', '...');
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendButton.click();
    });
  </script>
</body>
</html>
